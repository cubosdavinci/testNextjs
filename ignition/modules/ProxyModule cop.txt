import { buildModule } from "@nomicfoundation/hardhat-ignition/modules";

const proxyModule = buildModule("ProxyModule", (m) => {
  // Admin account
  const proxyAdminOwner = m.getAccount(0);
  const escrowv1 = m.contract("EscrowV1");

  // Deploy proxy (empty initializer for now)
  const proxy = m.contract("TransparentUpgradeableProxy", [
    escrowv1,
    proxyAdminOwner,
    "0x", // empty bytes
  ]);

  // Attach EscrowV1 ABI to proxy address
  const escrowProxy = m.contractAt("EscrowV1", proxy);

  // Initialize proxy AFTER deployment
  m.call(escrowProxy, "initialize", [
    "0x68021B74eA6322C745c5CaF0aB062aACE4a5d000", // _serverSigner
    "0x6F57fFB102a44EA9E2Ce2A302Ecb3cD2C4b9fb4D", // _platformTaxTreasury
    "0x6197B80eE72A4FbcfBE80904d45082C7300d3206", // _platformFeeTreasury
    3 * 24 * 60 * 60                               // _releaseDelay (3 days)
  ]);

  // Get proxy admin
  const proxyAdminAddress = m.readEventArgument(proxy, "AdminChanged", "newAdmin");
  const proxyAdmin = m.contractAt("ProxyAdmin", proxyAdminAddress);

  return { implementation: escrowv1, proxyAdmin, proxy };
});

const escrowv1Module = buildModule("EscrowV1Module", (m) => {
  const { implementation, proxy, proxyAdmin } = m.useModule(proxyModule);

  const escrowv1 = m.contractAt("EscrowV1", proxy);

  return { implementation, escrowv1, proxy, proxyAdmin };
});

export default escrowv1Module;
